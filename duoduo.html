<html><head><base href="/" />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å°æœ‹å‹æ¸¸æˆå¤©åœ°</title>
<style>
:root {
  --primary-color: #6B8DFF;
  --secondary-color: #FFB6E8;
  --background-color: #E6EEFF;
}

body {
  margin: 0;
  padding: 0;
  height: 100vh;
  font-family: 'Comic Sans MS', cursive;
  background: var(--background-color);
  overflow: hidden;
}

.container {
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.sky {
  flex-grow: 1;
  background: linear-gradient(180deg, #A4C6FF 0%, #E6EEFF 100%);
  position: relative;
  overflow: hidden;
}

.ground {
  height: 30vh;
  background: linear-gradient(180deg, var(--secondary-color) 0%, #FFC8F0 100%);
  border-radius: 50% 50% 0 0;
  transform: translateY(-40px);
}

.panda {
  width: 150px;
  height: 150px;
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  cursor: pointer;
  transition: transform 0.3s;
}

.panda:hover {
  transform: translate(-50%, -50%) scale(1.1);
}

.clouds {
  position: absolute;
  width: 100%;
  height: 100%;
}

.cloud {
  position: absolute;
  background: white;
  border-radius: 50px;
  animation: float 20s linear infinite;
}

.stars {
  position: absolute;
  width: 100%;
  height: 100%;
}

.star {
  position: absolute;
  width: 20px;
  height: 20px;
  opacity: 0.5;
  animation: twinkle 2s ease-in-out infinite;
}

@keyframes float {
  from { transform: translateX(100vw); }
  to { transform: translateX(-100px); }
}

@keyframes twinkle {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 1; }
}

@media screen and (max-width: 768px) {
  .menu {
    bottom: 10px;
    padding: 8px 15px;
  }

  .menu-item {
    width: 35px;
    height: 35px;
    font-size: 0.9em;
  }

  .chat-interface {
    width: 90%;
    bottom: 70px;
  }

  .game-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    padding: 10px;
  }

  .reading-grid {
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    padding: 10px;
  }

  .story-container {
    margin: 10px;
    padding: 15px;
  }

  .story-title {
    font-size: 1.5em;
  }

  .story-text {
    font-size: 1em;
    padding: 10px;
  }

  .math-game-container {
    margin: 10px;
    padding: 15px;
  }

  .problem-display {
    font-size: 2em;
  }

  .answer-grid input {
    width: 100px;
  }

  .drawing-controls {
    left: 10px;
    width: 120px;
  }

  .canvas-container {
    width: calc(100% - 140px);
    margin-left: 130px;
  }

  .tools-grid {
    grid-template-columns: 1fr 1fr;
  }

  .drawing-tool {
    width: 25px;
    height: 25px;
    font-size: 10px;
  }

  .color-option {
    width: 15px;
    height: 15px;
  }

  .back-button {
    top: 10px;
    left: 10px;
    padding: 8px 15px;
    font-size: 0.9em;
  }
}

@media (hover: none) {
  .menu-item:hover,
  .game-card:hover,
  .book-card:hover,
  .story-btn:hover,
  .chat-input button:hover {
    transform: none;
  }
  
  .menu-item:active,
  .game-card:active,
  .book-card:active,
  .story-btn:active,
  .chat-input button:active {
    transform: scale(0.95);
  }
}

.menu {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 20px;
  background: rgba(255, 255, 255, 0.8);
  padding: 10px 20px;
  border-radius: 30px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.menu-item {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--primary-color);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform 0.2s;
}

.menu-item:hover {
  transform: scale(1.1);
}

.chat-bubble {
  position: absolute;
  background: white;
  padding: 15px;
  border-radius: 20px;
  max-width: 200px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  display: none;
}

.chat-interface {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  width: 300px;
  background: white;
  border-radius: 15px;
  padding: 15px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  display: none;
}

.chat-messages {
  height: 200px;
  overflow-y: auto;
  margin-bottom: 10px;
  padding: 10px;
  background: #f5f5f5;
  border-radius: 10px;
}

.message {
  margin-bottom: 10px;
  padding: 8px;
  border-radius: 10px;
  max-width: 80%;
}

.user-message {
  background: var(--primary-color);
  color: white;
  margin-left: auto;
}

.panda-message {
  background: var(--secondary-color);
  color: black;
}

.chat-input {
  display: flex;
  gap: 10px;
}

.chat-input input {
  flex-grow: 1;
  padding: 8px;
  border: 2px solid var(--primary-color);
  border-radius: 20px;
  outline: none;
}

.chat-input button {
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 20px;
  padding: 8px 15px;
  cursor: pointer;
  transition: transform 0.2s;
}

.chat-input button:hover {
  transform: scale(1.05);
}

.game-page {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--background-color);
  display: none;
  flex-direction: column;
  padding: 20px;
  overflow-y: auto;
  z-index: 1000;
}

.game-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 20px;
  padding: 20px;
}

.game-card {
  background: white;
  border-radius: 15px;
  padding: 15px;
  text-align: center;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: transform 0.3s;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.game-card:hover {
  transform: scale(1.05);
}

.game-icon {
  width: 80px;
  height: 80px;
  background: var(--secondary-color);
  border-radius: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2em;
}

.game-title {
  font-size: 1.2em;
  color: #333;
  margin: 5px 0;
}

.game-age {
  font-size: 0.9em;
  color: #666;
}

.answer-option {
  transition: all 0.3s;
}
.answer-option:hover {
  background: var(--primary-color) !important;
  color: white;
}
.answer-option:active {
  transform: scale(0.95);
}

@media screen and (max-width: 768px) {
  #optionsContainer {
    grid-template-columns: 1fr;
  }
  .answer-option {
    font-size: 1.2em;
    padding: 15px !important;
  }
}

.loading-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--background-color);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

.reading-page {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--background-color);
  display: none;
  z-index: 1000;
  padding: 20px;
  overflow-y: auto;
}

.reading-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 20px;
  padding: 20px;
}

.book-card {
  background: white;
  border-radius: 15px;
  padding: 15px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: transform 0.3s;
}

.book-card:hover {
  transform: scale(1.05);
}

.book-cover {
  width: 100%;
  height: 200px;
  background: var(--secondary-color);
  border-radius: 8px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3em;
}

.book-title {
  font-size: 1.2em;
  color: #333;
  margin: 5px 0;
}

.book-age {
  font-size: 0.9em;
  color: #666;
}

.drawing-page {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--background-color);
  display: none;
  z-index: 1000;
  padding: 20px;
}

.story-reading-interface {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--background-color);
  display: none;
  z-index: 1100;
  padding: 20px;
  overflow-y: auto;
}

.story-container {
  max-width: 800px;
  margin: 0 auto;
  background: white;
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.story-title {
  text-align: center;
  color: var(--primary-color);
  font-size: 2em;
  margin-bottom: 30px;
}

.story-content {
  min-height: 400px;
  position: relative;
}

.story-page {
  display: none;
  animation: fadein 0.5s;
}

.story-page.active {
  display: block;
}

.story-illustration {
  width: 100%;
  height: 200px;
  margin-bottom: 20px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.story-text {
  font-size: 1.2em;
  line-height: 1.8;
  padding: 20px;
}

.story-controls {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  margin-top: 30px;
}

.story-btn {
  background: var(--primary-color);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 20px;
  cursor: pointer;
  transition: transform 0.2s;
}

.story-btn:hover {
  transform: scale(1.05);
}

.page-indicator {
  font-size: 1.1em;
  color: #666;
}

@keyframes fadein {
  from { opacity: 0; }
  to { opacity: 1; }
}

.drawing-controls {
  position: fixed;
  left: 20px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  flex-direction: column;
  gap: 4px;
  background: white;
  padding: 6px;
  border-radius: 15px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  max-height: 90vh;
  overflow-y: auto;
  width: 130px;
  transition: transform 0.3s ease;
}

.drawing-controls.collapsed {
  transform: translate(-130px, -50%);
}

.toggle-panel {
  position: fixed;
  left: 150px;
  top: 50%;
  transform: translateY(-50%);
  width: 25px;
  height: 50px;
  background: var(--primary-color);
  border: none;
  border-radius: 0 25px 25px 0;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  font-size: 18px;
  transition: left 0.3s ease;
  z-index: 1000;
}

.toggle-panel.collapsed {
  left: 20px;
}

.drawing-tool {
  width: 25px;
  height: 25px;
  border-radius: 6px;
  border: 2px solid var(--primary-color);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.3s;
  margin: 2px;
  font-size: 12px;
}

.tools-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2px;
  margin-bottom: 4px;
}

.actions-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 4px;
  margin: 8px 0;
}

.color-section {
  margin: 8px 0;
}

.drawing-tool.active {
  background: var(--primary-color);
  color: white;
}

.color-picker {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1px;
  margin: 6px 0;
  clear: both;
}

.grid-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 3px;
  margin: 8px 0;
  clear: both;
  width: 100%;
}

.grid-button {
  padding: 4px;
  background: white;
  border: 1px solid var(--primary-color);
  border-radius: 5px;
  cursor: pointer;
  font-size: 11px;
  white-space: nowrap;
}

.grid-button.full-width {
  grid-column: 1 / -1;
}

.grid-button.active {
  background: var(--primary-color);
  color: white;
}

.chinese-grid {
  position: absolute;
  top: 0;
  left: 0;
  pointer-events: none;
  z-index: 1;
}

.color-option {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid white;
}

.color-option.active {
  border-color: var(--primary-color);
}

.stroke-width {
  width: 100%;
  margin: 10px 0;
}

.canvas-container {
  position: relative;
  width: calc(100% - 170px);
  height: calc(100% - 40px);
  margin-left: 150px;
  background: white;
  border-radius: 15px;
  overflow: hidden;
  transition: margin-left 0.3s ease, width 0.3s ease;
}

.canvas-container.full-width {
  margin-left: 25px;
  width: calc(100% - 40px);
}

#drawingCanvas {
  position: absolute;
  top: 0;
  left: 0;
  cursor: crosshair;
}

.loading-panda {
  width: 100px;
  height: 100px;
  animation: bounce 1s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-20px); }
}

.back-button {
  position: fixed;
  top: 20px;
  left: 20px;
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 25px;
  padding: 10px 20px;
  cursor: pointer;
  z-index: 1001;
}

.math-game-interface {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--background-color);
  display: none;
  z-index: 1100;
  padding: 20px;
}

.math-game-container {
  max-width: 600px;
  margin: 20px auto;
  background: white;
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  text-align: center;
}

.problem-display {
  font-size: 2.5em;
  margin: 30px 0;
  color: var(--primary-color);
  min-height: 60px;
}

.answer-grid {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin: 20px 0;
}

.answer-grid input {
  width: 120px;
  padding: 10px;
  font-size: 1.2em;
  border: 2px solid var(--primary-color);
  border-radius: 10px;
  text-align: center;
}

.answer-grid button {
  padding: 10px 20px;
  font-size: 1.2em;
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
}

.feedback {
  min-height: 30px;
  margin: 20px 0;
  font-size: 1.2em;
}

.score-display {
  font-size: 1.2em;
  color: var(--primary-color);
  margin: 10px 0;
}
</style>
</head>
<body>

<div class="container">
  <div class="sky" id="sky">
    <div class="stars" id="stars"></div>
    <div class="clouds" id="clouds"></div>
    <div class="panda" id="panda">
      <svg viewBox="0 0 200 200">
        <circle cx="100" cy="100" r="90" fill="#FFFFFF"/>
        <circle cx="65" cy="80" r="25" fill="#000000"/>
        <circle cx="135" cy="80" r="25" fill="#000000"/>
        <ellipse cx="100" cy="120" rx="20" ry="15" fill="#000000"/>
        <circle cx="70" cy="85" r="8" fill="#FFFFFF"/>
        <circle cx="140" cy="85" r="8" fill="#FFFFFF"/>
      </svg>
    </div>
    <div class="chat-bubble" id="chatBubble">ä½ å¥½å•Šï¼æˆ‘æ˜¯ç†ŠçŒ«å¤šå¤šï¼Œè®©æˆ‘ä»¬ä¸€èµ·ç©è€å§ï¼</div>
  </div>
  <div class="ground"></div>
</div>
<div class="chat-interface" id="chatInterface">
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input">
    <input type="text" id="userInput" placeholder="å’Œç†ŠçŒ«å¤šå¤šèŠå¤©...">
    <button id="sendButton">å‘é€</button>
  </div>
</div>
<div class="loading-screen" id="loadingScreen">
  <div class="loading-panda">
    <svg viewBox="0 0 200 200">
      <circle cx="100" cy="100" r="90" fill="#FFFFFF"/>
      <circle cx="65" cy="80" r="25" fill="#000000"/>
      <circle cx="135" cy="80" r="25" fill="#000000"/>
      <ellipse cx="100" cy="120" rx="20" ry="15" fill="#000000"/>
      <circle cx="70" cy="85" r="8" fill="#FFFFFF"/>
      <circle cx="140" cy="85" r="8" fill="#FFFFFF"/>
    </svg>
  </div>
</div>
<div class="game-page" id="gamePage">
  <button class="back-button" id="backButton">è¿”å›</button>
  <div class="game-grid" id="gameGrid"></div>
</div>
<div class="drawing-page" id="drawingPage">
  <button class="back-button" id="drawingBackButton">è¿”å›</button>
  <div class="drawing-controls">
    <div class="tools-grid">
      <div class="drawing-tool active" data-tool="pencil">âœï¸</div>
      <div class="drawing-tool" data-tool="brush">ğŸ–Œï¸</div>
      <div class="drawing-tool" data-tool="eraser">ğŸ§½</div>
    </div>
    
    <input type="range" class="stroke-width" min="1" max="50" value="5">
    
    <div class="color-section">
      <input type="color" id="colorPicker" value="#000000">
      <div class="color-picker">
        <div class="color-option active" style="background: #000000" data-color="#000000"></div>
        <div class="color-option" style="background: #FF0000" data-color="#FF0000"></div>
        <div class="color-option" style="background: #00FF00" data-color="#00FF00"></div>
        <div class="color-option" style="background: #0000FF" data-color="#0000FF"></div>
        <div class="color-option" style="background: #FFFF00" data-color="#FFFF00"></div>
        <div class="color-option" style="background: #FF00FF" data-color="#FF00FF"></div>
        <div class="color-option" style="background: #00FFFF" data-color="#00FFFF"></div>
        <div class="color-option" style="background: #FFFFFF" data-color="#FFFFFF"></div>
        <div class="color-option" style="background: #808080" data-color="#808080"></div>
      </div>
    </div>

    <div class="actions-grid">
      <div class="drawing-tool" data-tool="clear">ğŸ—‘ï¸</div>
      <div class="drawing-tool" data-tool="save">ğŸ’¾</div>
    </div>

    <div class="grid-options">
      <button class="grid-button" data-grid="square">æ–¹æ ¼</button>
      <button class="grid-button" data-grid="chinese">ç”°å­—æ ¼</button>
      <button class="grid-button full-width" data-grid="none">æ— æ ¼å­</button>
    </div>
  </div>
  <div class="canvas-container">
    <canvas id="drawingCanvas"></canvas>
  </div>
</div>
<div class="menu">
  <div class="menu-item">ğŸ®</div>
  <div class="menu-item">ğŸ’¬</div>
  <div class="menu-item">ğŸ¨</div>
  <div class="menu-item">ğŸ“š</div>
</div>

<div class="reading-page" id="readingPage">
  <button class="back-button" id="readingBackButton">è¿”å›</button>
  <div class="reading-grid" id="readingGrid"></div>
</div>

<div class="story-reading-interface" id="storyReadingInterface">
  <button class="back-button" id="storyBackButton">è¿”å›</button>
  <div class="story-container">
    <h1 class="story-title">å°çº¢å¸½</h1>
    <div class="story-content">
      <div class="story-page active">
        <div class="story-illustration">
          <svg viewBox="0 0 300 200">
            <path d="M150 50 Q 180 30 200 50" stroke="red" fill="none" stroke-width="5"/>
            <circle cx="150" cy="70" r="40" fill="#FFE4E1"/>
            <path d="M130 90 Q 150 100 170 90" stroke="#000" fill="none" stroke-width="2"/>
          </svg>
        </div>
        <p class="story-text">
          ä»å‰ï¼Œæœ‰ä¸€ä¸ªå¯çˆ±çš„å°å¥³å­©ï¼Œå¥¹æ€»æ˜¯æˆ´ç€å¥¶å¥¶é€ç»™å¥¹çš„çº¢è‰²å°å¸½å­ï¼Œæ‰€ä»¥å¤§å®¶éƒ½å«å¥¹"å°çº¢å¸½"ã€‚
        </p>
      </div>
    </div>
    <div class="story-controls">
      <button class="story-btn" id="prevPage">ä¸Šä¸€é¡µ</button>
      <span class="page-indicator">1 / 5</span>
      <button class="story-btn" id="nextPage">ä¸‹ä¸€é¡µ</button>
    </div>
  </div>
</div>

<div class="math-game-interface" id="mathGameInterface">
  <button class="back-button" id="mathGameBackButton">è¿”å›</button>
  <div class="math-game-container">
    <h1 class="game-title">æ•°å­¦å°æ¸¸æˆ</h1>
    <div class="score-display">åˆ†æ•°: <span id="mathScore">0</span></div>
    <div class="problem-display" id="problemDisplay"></div>
    <div class="answer-grid">
      <input type="number" id="mathAnswer" placeholder="è¾“å…¥ç­”æ¡ˆ">
      <button id="submitAnswer">ç¡®è®¤</button>
    </div>
    <div class="feedback" id="feedback"></div>
  </div>
</div>

<div class="math-game-interface" id="idiomGameInterface">
  <button class="back-button" id="idiomGameBackButton">è¿”å›</button>
  <div class="math-game-container">
    <h1 class="game-title">æˆè¯­æ¥é¾™</h1>
    <div class="score-display">åˆ†æ•°: <span id="idiomScore">0</span></div>
    <div id="currentIdiom" class="problem-display"></div>
    <div class="answer-grid">
      <input type="text" id="idiomAnswer" placeholder="è¾“å…¥æˆè¯­">
      <button id="submitIdiomAnswer">ç¡®è®¤</button>
    </div>
    <div class="feedback" id="idiomFeedback"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const drawingPage = document.getElementById('drawingPage');
  const canvas = document.getElementById('drawingCanvas');
  if (!canvas) {
    console.error('Drawing canvas not found');
    return;
  }
  const ctx = canvas.getContext('2d');
  let isDrawing = false;
  let currentTool = 'pencil';
  let currentColor = '#000000';
  let currentWidth = 5;
  let lastX = 0;
  let lastY = 0;
  let currentGrid = 'none';
  let brushPressure = 50;

function resizeCanvas() {
  const container = canvas.parentElement;
  canvas.width = container.offsetWidth;
  canvas.height = container.offsetHeight;
  
  ctx.fillStyle = '#FFFFFF';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  ctx.strokeStyle = currentColor;
  ctx.lineWidth = currentWidth;
  
  drawGrid();
}

  function drawGrid() {
    const oldGrid = document.querySelector('.chinese-grid');
    if (oldGrid) oldGrid.remove();
    
    if (currentGrid === 'none') return;

    const gridCanvas = document.createElement('canvas');
    gridCanvas.className = 'chinese-grid';
    gridCanvas.width = canvas.width;
    gridCanvas.height = canvas.height;
    gridCanvas.style.position = 'absolute';
    gridCanvas.style.top = '0';
    gridCanvas.style.left = '0';
    gridCanvas.style.pointerEvents = 'none';
    
    const gridCtx = gridCanvas.getContext('2d');
    gridCtx.strokeStyle = '#ddd';
    gridCtx.lineWidth = 1;

    if (currentGrid === 'square') {
      const gridSize = 50;
      for (let x = 0; x <= canvas.width; x += gridSize) {
        gridCtx.beginPath();
        gridCtx.moveTo(x, 0);
        gridCtx.lineTo(x, canvas.height);
        gridCtx.stroke();
      }
      
      for (let y = 0; y <= canvas.height; y += gridSize) {
        gridCtx.beginPath();
        gridCtx.moveTo(0, y);
        gridCtx.lineTo(canvas.width, y);
        gridCtx.stroke();
      }
    } else if (currentGrid === 'chinese') {
      const cellSize = 100;
      const numCellsX = Math.floor(canvas.width / cellSize);
      const numCellsY = Math.floor(canvas.height / cellSize);
      
      for (let i = 0; i < numCellsX; i++) {
        for (let j = 0; j < numCellsY; j++) {
          const x = i * cellSize;
          const y = j * cellSize;
          
          gridCtx.strokeRect(x, y, cellSize, cellSize);
          
          gridCtx.beginPath();
          gridCtx.moveTo(x, y);
          gridCtx.lineTo(x + cellSize, y + cellSize);
          gridCtx.moveTo(x + cellSize, y);
          gridCtx.lineTo(x, y + cellSize);
          gridCtx.stroke();
          
          gridCtx.beginPath();
          gridCtx.moveTo(x + cellSize/2, y);
          gridCtx.lineTo(x + cellSize/2, y + cellSize);
          gridCtx.moveTo(x, y + cellSize/2);
          gridCtx.lineTo(x + cellSize, y + cellSize/2);
          gridCtx.stroke();
        }
      }
    }

    canvas.parentElement.appendChild(gridCanvas);
  }

  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  // Add toggle button to drawing controls panel
  const drawingControls = document.querySelector('.drawing-controls');
  if (drawingControls) {
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'toggle-panel';
    toggleBtn.innerHTML = 'â—€';
    document.querySelector('.drawing-page').appendChild(toggleBtn);

    toggleBtn.addEventListener('click', () => {
      const isCollapsed = drawingControls.classList.toggle('collapsed');
      const canvasContainer = document.querySelector('.canvas-container');
      toggleBtn.classList.toggle('collapsed');
      
      if (canvasContainer) {
        canvasContainer.classList.toggle('full-width');
      }
      
      // Update toggle button text
      toggleBtn.innerHTML = isCollapsed ? 'â–¶' : 'â—€';
      
      // Resize canvas after transition
      setTimeout(resizeCanvas, 300);
    });
  }

  document.querySelectorAll('.grid-button').forEach(button => {
    button.addEventListener('click', () => {
      document.querySelectorAll('.grid-button').forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      currentGrid = button.dataset.grid;
      drawGrid();
    });
  });

  function draw(e) {
    if (!isDrawing) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    ctx.beginPath();
    ctx.strokeStyle = currentTool === 'eraser' ? '#FFFFFF' : currentColor;
    
    if (currentTool === 'brush') {
      const pressure = (brushPressure / 100) * Math.min(Math.abs(x - lastX), Math.abs(y - lastY));
      ctx.lineWidth = Math.max(1, currentWidth * (1 - pressure/100));
      ctx.moveTo(lastX, lastY);
      
      const dx = x - lastX;
      const dy = y - lastY;
      const angle = Math.atan2(dy, dx);
      
      ctx.quadraticCurveTo(
        lastX + Math.cos(angle) * pressure,
        lastY + Math.sin(angle) * pressure,
        x,
        y
      );
    } else {
      ctx.lineWidth = currentWidth;
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
    }
    
    ctx.stroke();
    lastX = x;
    lastY = y;
  }

  canvas.addEventListener('mousedown', (e) => {
    e.preventDefault();
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    lastX = e.clientX - rect.left;
    lastY = e.clientY - rect.top;
  });

  canvas.addEventListener('mousemove', (e) => {
    e.preventDefault();
    draw(e);
  });
  canvas.addEventListener('mouseup', () => isDrawing = false);
  canvas.addEventListener('mouseout', () => isDrawing = false);

  canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    isDrawing = true;
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    lastX = touch.clientX - rect.left;
    lastY = touch.clientY - rect.top;
  });

  canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (!isDrawing) return;
    const touch = e.touches[0];
    draw({clientX: touch.clientX, clientY: touch.clientY});
  });

  canvas.addEventListener('touchend', () => isDrawing = false);
  canvas.addEventListener('touchcancel', () => isDrawing = false);

  document.querySelectorAll('.drawing-tool').forEach(tool => {
    tool.addEventListener('click', () => {
      const toolType = tool.dataset.tool;
      
      if (toolType === 'clear') {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºç”»å¸ƒå—ï¼Ÿ')) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        return;
      }
      
      if (toolType === 'save') {
        const link = document.createElement('a');
        link.download = 'æˆ‘çš„ç”»ä½œ.png';
        link.href = canvas.toDataURL();
        link.click();
        return;
      }
      
      document.querySelectorAll('.drawing-tool').forEach(t => t.classList.remove('active'));
      if (['pencil', 'brush', 'eraser'].includes(toolType)) {
        tool.classList.add('active');
        currentTool = toolType;
      }
    });
  });

  document.querySelectorAll('.color-option').forEach(color => {
    color.addEventListener('click', () => {
      document.querySelectorAll('.color-option').forEach(c => c.classList.remove('active'));
      color.classList.add('active');
      currentColor = color.dataset.color;
    });
  });

  document.querySelector('.stroke-width').addEventListener('input', (e) => {
    currentWidth = e.target.value;
  });

  const starsContainer = document.getElementById('stars');
  for(let i = 0; i < 50; i++) {
    const star = document.createElement('div');
    star.className = 'star';
    star.style.left = Math.random() * 100 + '%';
    star.style.top = Math.random() * 100 + '%';
    star.innerHTML = 'â­';
    starsContainer.appendChild(star);
  }

  const cloudsContainer = document.getElementById('clouds');
  for(let i = 0; i < 5; i++) {
    const cloud = document.createElement('div');
    cloud.className = 'cloud';
    cloud.style.top = Math.random() * 50 + '%';
    cloud.style.animationDelay = (i * 4) + 's';
    cloud.innerHTML = 'â˜ï¸';
    cloud.style.fontSize = (30 + Math.random() * 20) + 'px';
    cloudsContainer.appendChild(cloud);
  }

  const panda = document.getElementById('panda');
  const chatBubble = document.getElementById('chatBubble');
  
  panda.addEventListener('click', () => {
    chatBubble.style.display = 'block';
    chatBubble.style.left = (panda.offsetLeft + 100) + 'px';
    chatBubble.style.top = (panda.offsetTop - 50) + 'px';
    
    setTimeout(() => {
      chatBubble.style.display = 'none';
    }, 3000);
  });

  panda.addEventListener('touchstart', (e) => {
    e.preventDefault();
    chatBubble.style.display = 'block';
    chatBubble.style.left = (panda.offsetLeft + 100) + 'px';
    chatBubble.style.top = (panda.offsetTop - 50) + 'px';
    
    setTimeout(() => {
      chatBubble.style.display = 'none';
    }, 3000);
  });

  const menuItems = document.querySelectorAll('.menu-item');
  menuItems[1].addEventListener('click', () => {
    const chatInterface = document.getElementById('chatInterface');
    chatInterface.style.display = chatInterface.style.display === 'none' ? 'block' : 'none';
  });

  const chatMessages = document.getElementById('chatMessages');
  const userInput = document.getElementById('userInput');
  const sendButton = document.getElementById('sendButton');

  async function getPandaResponse(userMessage) {
    try {
      const response = await fetch('https://api.deepseek.com/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer sk-ab1aaf35e77640b39b94ed461fd5d6c3'
        },
        body: JSON.stringify({
          model: "deepseek-chat",
          messages: [
            {
              "role": "system", 
              "content": "ä½ æ˜¯ä¸€ä¸ªå¯çˆ±çš„ç†ŠçŒ«å¤šå¤šï¼Œæ­£åœ¨å’Œ2-12å²çš„å°æœ‹å‹èŠå¤©ã€‚è¦ç”¨æ¸©æŸ”ã€æœ‰è¶£ã€å……æ»¡ç«¥è¶£çš„æ–¹å¼å›ç­”ã€‚å›ç­”è¦ç®€çŸ­ï¼Œæ˜“æ‡‚ï¼Œå¯Œæœ‰æ•™è‚²æ„ä¹‰ã€‚"
            },
            {
              "role": "user",
              "content": userMessage
            }
          ],
          stream: false
        })
      });

      if (!response.ok) {
        throw new Error('APIè¯·æ±‚å¤±è´¥');
      }

      const data = await response.json();
      return data.choices[0].message.content;
    } catch (error) {
      console.error('èŠå¤©å‡ºé”™äº†:', error);
      return 'å“å‘€ï¼Œæˆ‘æœ‰ç‚¹ç´¯äº†ï¼Œä¼‘æ¯ä¸€ä¸‹å†èŠå§ï¼';
    }
  }

  function addMessage(content, isUser) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'panda-message'}`;
    messageDiv.textContent = content;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  sendButton.addEventListener('click', async () => {
    const message = userInput.value.trim();
    if (!message) return;

    addMessage(message, true);
    userInput.value = '';

    const response = await getPandaResponse(message);
    addMessage(response, false);
  });

  userInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendButton.click();
    }
  });

  const games = [
    { 
      title: "æ•°å­—ç®—æœ¯", 
      icon: "ğŸ”¢", 
      age: "6-10å²", 
      type: "æ•°å­¦",
      playable: true 
    },
    { 
      title: "çœ‹å›¾è¯†å­—", 
      icon: "ğŸ¯", 
      age: "4-8å²", 
      type: "è¯­è¨€",
      playable: true
    },
    {
      title: "æˆè¯­æ¥é¾™",
      icon: "ğŸ‰",
      age: "7-12å²", 
      type: "è¯­æ–‡",
      playable: true
    }
  ];

  const loadingScreen = document.getElementById('loadingScreen');
  const gamePage = document.getElementById('gamePage');
  const gameGrid = document.getElementById('gameGrid');
  const backButton = document.getElementById('backButton');
  
  menuItems[0].addEventListener('click', () => {
    loadingScreen.style.display = 'flex';
    
    setTimeout(() => {
      loadingScreen.style.display = 'none';
      gamePage.style.display = 'block';
      
      gameGrid.innerHTML = '';
      games.forEach(game => {
        const card = document.createElement('div');
        card.className = 'game-card';
        card.innerHTML = `
          <div class="game-icon">${game.icon}</div>
          <div class="game-title">${game.title}</div>
          <div class="game-age">${game.age}</div>
        `;
        card.addEventListener('click', () => {
          loadingScreen.style.display = 'flex';
          
          setTimeout(() => {
            loadingScreen.style.display = 'none';
            switch(game.title) {
              case "æ•°å­—ç®—æœ¯":
                mathGameInterface.style.display = 'block';
                mathScore = 0;
                document.getElementById('mathScore').textContent = mathScore;
                document.getElementById('mathAnswer').value = '';
                document.getElementById('feedback').textContent = '';
                generateMathProblem();
                break;
              case "çœ‹å›¾è¯†å­—":
                startLanguageGame();
                break;
              default:
                alert(`å¼€å§‹ç© ${game.title}ï¼`);
            }
          }, 1000);
        });
        gameGrid.appendChild(card);
      });
    }, 1000);
  });
  
  backButton.addEventListener('click', () => {
    gamePage.style.display = 'none';
  });

  menuItems[2].addEventListener('click', () => {
    drawingPage.style.display = 'block';
    setTimeout(resizeCanvas, 100);
  });

  document.getElementById('drawingBackButton').addEventListener('click', () => {
    drawingPage.style.display = 'none';
  });

  const readingPage = document.getElementById('readingPage');
  const readingGrid = document.getElementById('readingGrid');

  const books = [
    { title: "å°çº¢å¸½", icon: "ğŸ“•", age: "3-6å²", type: "ç«¥è¯æ•…äº‹" }
  ];

  const storyPages = [
    {
      text: 'ä»å‰ï¼Œæœ‰ä¸€ä¸ªå¯çˆ±çš„å°å¥³å­©ï¼Œå¥¹æ€»æ˜¯æˆ´ç€å¥¶å¥¶é€ç»™å¥¹çš„çº¢è‰²å°å¸½å­ï¼Œæ‰€ä»¥å¤§å®¶éƒ½å«å¥¹"å°çº¢å¸½"ã€‚',
      illustration: 'å°çº¢å¸½çš„å½¢è±¡'
    },
    {
      text: 'æœ‰ä¸€å¤©ï¼Œå¦ˆå¦ˆè®©å°çº¢å¸½å»ç»™ç”Ÿç—…çš„å¥¶å¥¶é€é£Ÿç‰©ã€‚å¦ˆå¦ˆå®å˜±å¥¹è¦å°å¿ƒï¼Œä¸è¦ç¦»å¼€å°è·¯ã€‚',
      illustration: 'å¦ˆå¦ˆå’Œå°çº¢å¸½'
    },
    {
      text: 'åœ¨æ£®æ—é‡Œï¼Œå°çº¢å¸½é‡åˆ°äº†ä¸€åªå¤§ç°ç‹¼ã€‚ç‹¼å‡è£…å‹å–„ï¼Œè¯¢é—®å¥¹è¦å»å“ªé‡Œã€‚',
      illustration: 'æ£®æ—å’Œå¤§ç°ç‹¼'
    },
    {
      text: 'å¤§ç°ç‹¼æå‰èµ¶åˆ°å¥¶å¥¶å®¶ï¼Œå‡æ‰®æˆå¥¶å¥¶ã€‚å½“å°çº¢å¸½åˆ°è¾¾æ—¶ï¼Œå‘ç°å¥¶å¥¶çœ‹èµ·æ¥å¾ˆå¥‡æ€ªã€‚',
      illustration: 'å¥¶å¥¶åºŠè¾¹çš„åœºæ™¯'
    },
    {
      text: 'å¹¸è¿çš„æ˜¯ï¼ŒçŒäººå¬åˆ°äº†å£°éŸ³èµ¶æ¥æ•‘äº†å°çº¢å¸½å’Œå¥¶å¥¶ã€‚ä»æ­¤ä»¥åï¼Œå°çº¢å¸½å†ä¹Ÿä¸ä¼šéšä¾¿ç›¸ä¿¡é™Œç”Ÿäººäº†ã€‚',
      illustration: 'å¿«ä¹ç»“å±€'
    }
  ];


let currentStoryPages;

  menuItems[3].addEventListener('click', () => {
    loadingScreen.style.display = 'flex';
    
    setTimeout(() => {
      loadingScreen.style.display = 'none';
      readingPage.style.display = 'block';
      
      readingGrid.innerHTML = '';
      books.forEach(book => {
        const card = document.createElement('div');
        card.className = 'book-card';
        card.innerHTML = `
          <div class="book-cover">${book.icon}</div>
          <div class="book-title">${book.title}</div>
          <div class="book-age">${book.age}</div>
        `;
        card.addEventListener('click', () => {
          const bookTitle = book.title;
          if (bookTitle === "å°çº¢å¸½") {
            storyReadingInterface.style.display = 'block';
            showPage(1);
          } else {
            alert(`å¼€å§‹é˜…è¯» ${book.title}ï¼`);
          }
        });
        readingGrid.appendChild(card);
      });
    }, 1000);
  });

  document.getElementById('readingBackButton').addEventListener('click', () => {
    readingPage.style.display = 'none';
  });

  const storyReadingInterface = document.getElementById('storyReadingInterface');
  const storyBackButton = document.getElementById('storyBackButton');
  let currentPage = 1;

  document.querySelectorAll('.book-card').forEach(card => {
    card.addEventListener('click', (e) => {
      const bookTitle = card.querySelector('.book-title').textContent;
      if (bookTitle === "å°çº¢å¸½") {
        storyReadingInterface.style.display = 'block';
        currentStoryPages = storyPages;
        document.querySelector('.story-title').textContent = 'å°çº¢å¸½';
        showPage(1);
      }
    });
  });

  storyBackButton.addEventListener('click', () => {
    storyReadingInterface.style.display = 'none';
  });

  document.getElementById('prevPage').addEventListener('click', () => {
    if (currentPage > 1) {
      showPage(currentPage - 1);
    }
  });

  document.getElementById('nextPage').addEventListener('click', () => {
    if (currentPage < storyPages.length) {
      showPage(currentPage + 1);
    }
  });

  function showPage(pageNum) {
    const storyContent = document.querySelector('.story-content');
    const page = storyPages[pageNum-1];
    let illustration;
    
    switch(pageNum) {
      case 1:
        illustration = `
          <svg viewBox="0 0 300 200">
            <circle cx="150" cy="70" r="40" fill="#FFE4E1"/>
            <path d="M150 30 Q 180 30 200 50" stroke="red" fill="none" stroke-width="5"/>
            <path d="M130 80 Q 150 90 170 80" stroke="#000" fill="none" stroke-width="2"/>
          </svg>`;
        break;
      case 2:
        illustration = `
          <svg viewBox="0 0 300 200">
            <circle cx="120" cy="100" r="30" fill="#FFE4E1"/>
            <circle cx="180" cy="80" r="40" fill="#FFB6C1"/>
            <path d="M110 110 Q 120 120 130 110" stroke="#000" fill="none" stroke-width="2"/>
          </svg>`;
        break;
      case 3:
        illustration = `
          <svg viewBox="0 0 300 200">
            <circle cx="120" cy="100" r="30" fill="#FFE4E1"/>
            <path d="M200 80 Q 220 100 240 80" fill="#808080"/>
            <circle cx="220" cy="70" r="20" fill="#808080"/>
          </svg>`;
        break;
      case 4:
        illustration = `
          <svg viewBox="0 0 300 200">
            <rect x="100" y="50" width="150" height="100" fill="#F5F5F5"/>
            <circle cx="200" cy="80" r="30" fill="#808080"/>
            <path d="M190 90 Q 200 100 210 90" stroke="#000" fill="none" stroke-width="2"/>
          </svg>`;
        break;
      case 5:
        illustration = `
          <svg viewBox="0 0 300 200">
            <circle cx="120" cy="100" r="30" fill="#FFE4E1"/>
            <circle cx="180" cy="100" r="30" fill="#A0522D"/>
            <path d="M110 110 Q 120 120 130 110" stroke="#000" fill="none" stroke-width="2"/>
          </svg>`;
        break;
    }
    
    storyContent.innerHTML = `
      <div class="story-page active">
        <div class="story-illustration">
          ${illustration}
        </div>
        <p class="story-text">${page.text}</p>
      </div>
    `;
    currentPage = pageNum;
    document.querySelector('.page-indicator').textContent = `${pageNum} / ${storyPages.length}`;
  }

  let currentAnswer = 0;
  let mathScore = 0;
  const mathGameInterface = document.getElementById('mathGameInterface');
  const mathGameBackButton = document.getElementById('mathGameBackButton');

  function generateMathProblem() {
    const operations = ['+', '-'];
    const operation = operations[Math.floor(Math.random() * operations.length)];
    let num1, num2;
    
    if (operation === '+') {
      num1 = Math.floor(Math.random() * 10) + 1;
      num2 = Math.floor(Math.random() * 10) + 1;
      currentAnswer = num1 + num2;
    } else {
      num1 = Math.floor(Math.random() * 10) + 1;
      num2 = Math.floor(Math.random() * num1) + 1; // Ensure positive result
      currentAnswer = num1 - num2;
    }
    
    document.getElementById('problemDisplay').textContent = `${num1} ${operation} ${num2} = ?`;
  }

  function checkAnswer() {
    const userAnswer = parseInt(document.getElementById('mathAnswer').value);
    const feedback = document.getElementById('feedback');
    
    if (userAnswer === currentAnswer) {
      feedback.textContent = 'å¤ªæ£’äº†ï¼ç­”å¯¹äº†ï¼ğŸ‘';
      feedback.style.color = '#4CAF50';
      mathScore += 10;
      document.getElementById('mathScore').textContent = mathScore;
      setTimeout(() => {
        document.getElementById('mathAnswer').value = '';
        feedback.textContent = '';
        generateMathProblem();
      }, 1500);
    } else {
      feedback.textContent = 'å†æƒ³æƒ³çœ‹ï½';
      feedback.style.color = '#F44336';
    }
  }

  const idioms = [
    "æœ›çœ¼æ¬²ç©¿",
    "ç©¿é’ˆå¼•çº¿",
    "çº¿æ¥çº¿å»", 
    "å»å¤´ä¸è§å°¾",
    "å°¾éšå…¶å",
    "åæ¥å±…ä¸Š",
    "ä¸Šä¸‹å…¶æ‰‹",
    "æ‰‹èˆè¶³è¹ˆ",
    "é“å¬é€”è¯´",
    "è¯´é•¿é“çŸ­"
  ];

  async function getAIIdiomResponse(lastIdiom) {
    try {
      const response = await fetch('https://api.deepseek.com/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer sk-ab1aaf35e77640b39b94ed461fd5d6c3'
        },
        body: JSON.stringify({
          model: "deepseek-chat",
          messages: [
            {
              "role": "system",
              "content": "ä½ æ˜¯ä¸€ä¸ªæˆè¯­æ¥é¾™åŠ©æ‰‹ã€‚è¯·æ ¹æ®ç»™å®šçš„æˆè¯­ï¼Œå›ç­”ä¸€ä¸ªä»¥è¯¥æˆè¯­æœ€åä¸€ä¸ªå­—å¼€å¤´çš„æˆè¯­ã€‚åªéœ€å›å¤æˆè¯­å³å¯ï¼Œæ— éœ€å…¶ä»–è§£é‡Šã€‚"
            },
            {
              "role": "user",
              "content": `è¯·æ¥ä»¥"${lastIdiom}"æœ€åä¸€ä¸ªå­—å¼€å¤´çš„æˆè¯­`
            }
          ]
        })
      });

      if (!response.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');
      const data = await response.json();
      return data.choices[0].message.content.trim();
    } catch (error) {
      console.error('AIæ¥é¾™å‡ºé”™:', error);
      return null;
    }
  }

  let currentIdiom = '';
  let idiomScore = 0;
  const idiomGameInterface = document.getElementById('idiomGameInterface');

  function startIdiomGame() {
    idiomScore = 0;
    document.getElementById('idiomScore').textContent = idiomScore;
    currentIdiom = idioms[Math.floor(Math.random() * idioms.length)];
    document.getElementById('currentIdiom').textContent = currentIdiom;
    document.getElementById('idiomAnswer').value = '';
    document.getElementById('idiomFeedback').textContent = '';
  }

  async function checkIdiom() {
    const userAnswer = document.getElementById('idiomAnswer').value.trim();
    const feedback = document.getElementById('idiomFeedback');
    
    if (!userAnswer) {
      feedback.textContent = 'è¯·è¾“å…¥æˆè¯­';
      feedback.style.color = '#F44336';
      return;
    }

    const lastChar = currentIdiom.charAt(currentIdiom.length - 1);
    const firstChar = userAnswer.charAt(0);
    
    if (firstChar === lastChar && idioms.includes(userAnswer)) {
      feedback.textContent = 'æ¥é¾™æˆåŠŸï¼ğŸ‘';
      feedback.style.color = '#4CAF50';
      idiomScore += 10;
      document.getElementById('idiomScore').textContent = idiomScore;
      
      // Get AI response
      feedback.textContent = 'AIæ€è€ƒä¸­...';
      const aiResponse = await getAIIdiomResponse(userAnswer);
      
      if (aiResponse) {
        setTimeout(() => {
          currentIdiom = aiResponse;
          document.getElementById('currentIdiom').textContent = currentIdiom;
          document.getElementById('idiomAnswer').value = '';
          feedback.textContent = 'AIå·²æ¥é¾™ï¼Œè½®åˆ°ä½ äº†ï¼';
        }, 1500);
      } else {
        setTimeout(() => {
          currentIdiom = userAnswer;
          document.getElementById('currentIdiom').textContent = currentIdiom;
          document.getElementById('idiomAnswer').value = '';
          feedback.textContent = 'AIæ¥é¾™å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨ä½ çš„ç­”æ¡ˆ';
        }, 1500);
      }
    } else {
      feedback.textContent = 'ä¸ç¬¦åˆè§„åˆ™æˆ–ä¸æ˜¯æ­£ç¡®çš„æˆè¯­';
      feedback.style.color = '#F44336';
    }
  }

  gameGrid.addEventListener('click', (e) => {
    const card = e.target.closest('.game-card');
    if (!card) return;
    
    const title = card.querySelector('.game-title').textContent;
    if (title === "æ•°å­—ç®—æœ¯") {
      mathGameInterface.style.display = 'block';
      mathScore = 0;
      document.getElementById('mathScore').textContent = mathScore;
      document.getElementById('mathAnswer').value = '';
      document.getElementById('feedback').textContent = '';
      generateMathProblem();
    } else if (title === "æˆè¯­æ¥é¾™") {
      idiomGameInterface.style.display = 'block';
      startIdiomGame();
    }
  });

  document.getElementById('idiomGameBackButton').addEventListener('click', () => {
    idiomGameInterface.style.display = 'none';
  });

  document.getElementById('submitIdiomAnswer').addEventListener('click', () => checkIdiom());
  document.getElementById('idiomAnswer').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      checkIdiom();
    }
  });

  mathGameBackButton.addEventListener('click', () => {
    mathGameInterface.style.display = 'none';
  });

  document.getElementById('submitAnswer').addEventListener('click', checkAnswer);
  document.getElementById('mathAnswer').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      checkAnswer();
    }
  });

  async function getAIWordAndSvg() {
    try {
      const response = await fetch('https://api.deepseek.com/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer sk-ab1aaf35e77640b39b94ed461fd5d6c3'
        },
        body: JSON.stringify({
          model: "deepseek-chat",
          messages: [
            {
              "role": "system",
              "content": "ä½ æ˜¯ä¸€ä¸ªå›¾æ–‡ç”ŸæˆåŠ©æ‰‹ã€‚æ¯æ¬¡è¯·éšæœºé€‰æ‹©ä¸€ä¸ªç®€å•çš„äº‹ç‰©ï¼ˆå¦‚ï¼šèŠ±ã€æ ‘ã€é±¼ã€æ˜Ÿæ˜Ÿã€æœˆäº®ã€å±±ã€æ°´ç­‰ï¼‰ç”Ÿæˆå¯¹åº”çš„æ±‰å­—å’ŒSVGå›¾å½¢ã€‚ç¡®ä¿æ¯æ¬¡ç”Ÿæˆä¸åŒçš„å†…å®¹ã€‚å›å¤æ ¼å¼ä¸ºJSON: {word: 'æ­£ç¡®æ±‰å­—', svg: 'svgä»£ç ', options: ['é”™è¯¯é€‰é¡¹1', 'é”™è¯¯é€‰é¡¹2', 'é”™è¯¯é€‰é¡¹3']}"
            },
            {
              "role": "user", 
              "content": "éšæœºç”Ÿæˆä¸€ä¸ªç®€å•çš„æ±‰å­—ã€SVGå›¾å½¢å’Œ3ä¸ªé”™è¯¯é€‰é¡¹" 
            }
          ]
        })
      });

      if (!response.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');
      const data = await response.json();
      try {
        const result = JSON.parse(data.choices[0].message.content);
        return result;
      } catch (e) {
        const fallbackOptions = [
          {
            word: "èŠ±",
            svg: '<path d="M100,70 C130,70 130,130 100,130 C70,130 70,70 100,70" fill="#FF69B4"/><circle cx="100" cy="100" r="10" fill="#FFD700"/>',
            options: ["è‰", "æ ‘", "å¶"]
          },
          {
            word: "é±¼",
            svg: '<path d="M60,100 C100,70 140,70 180,100 C140,130 100,130 60,100" fill="#6495ED"/>',
            options: ["è™¾", "èŸ¹", "é¾Ÿ"]
          },
          {
            word: "æœˆ",
            svg: '<path d="M100,50 A50,50 0 1,1 100,150 A40,40 0 1,0 100,50" fill="#FFD700"/>',
            options: ["æ—¥", "æ˜Ÿ", "äº‘"]
          }
        ];
        return fallbackOptions[Math.floor(Math.random() * fallbackOptions.length)];
      }
    } catch (error) {
      console.error('è·å–AIå›¾æ–‡å¤±è´¥:', error);
      const fallbackOptions = [
        {
          word: "æ ‘",
          svg: `
            <rect x="90" y="100" width="20" height="70" fill="#8B4513"/>
            <path d="M100,40 L60,100 L140,100 Z" fill="#228B22"/>
            <path d="M100,70 L50,130 L150,130 Z" fill="#228B22"/>
            <path d="M100,100 L40,160 L160,160 Z" fill="#228B22"/>
          `,
          options: ["èŠ±", "è‰", "ç«¹"]
        },
        {
          word: "é±¼",
          svg: `
            <path d="M60,100 Q100,70 140,100 Q100,130 60,100" fill="#6495ED"/>
            <path d="M140,100 L160,80 L160,120 Z" fill="#6495ED"/>
            <circle cx="80" cy="90" r="5" fill="#000"/>
            <path d="M120,100 Q140,80 160,100 Q140,120 120,100" fill="#6495ED" opacity="0.5"/>
          `,
          options: ["è™¾", "èŸ¹", "é¾Ÿ"]
        },
        {
          word: "èŠ±",
          svg: `
            <path d="M100,60 Q120,60 120,80 Q120,100 100,100 Q80,100 80,80 Q80,60 100,60" fill="#FF69B4"/>
            <path d="M100,60 Q140,60 140,100 Q140,140 100,140 Q60,140 60,100 Q60,60 100,60" fill="#FF69B4" opacity="0.6"/>
            <circle cx="100" cy="100" r="10" fill="#FFD700"/>
            <path d="M95,150 L105,150 L100,180 Z" fill="#228B22"/>
            <path d="M100,140 L80,170 L120,170 Z" fill="#228B22"/>
          `,
          options: ["è‰", "å¶", "æ ‘"]
        },
        {
          word: "æœˆ",
          svg: `
            <path d="M100,40 A60,60 0 1,1 100,160 A48,48 0 1,0 100,40" fill="#FFD700"/>
            <circle cx="80" cy="70" r="8" fill="#FFF5DD"/>
            <circle cx="120" cy="110" r="10" fill="#FFF5DD"/>
          `,
          options: ["æ—¥", "æ˜Ÿ", "äº‘"]
        },
        {
          word: "å±±",
          svg: `
            <path d="M20,160 L100,60 L180,160 Z" fill="#A0522D"/>
            <path d="M60,160 L120,80 L180,160" fill="#8B4513"/>
            <path d="M20,160 L80,100 L140,160" fill="#6B4423"/>
            <path d="M80,140 L100,160" stroke="#FFF" stroke-width="2"/>
          `,
          options: ["æ°´", "æ²³", "è·¯"]
        }
      ];
      return fallbackOptions[Math.floor(Math.random() * fallbackOptions.length)];
    }
  }

  function startLanguageGame() {
    const languageGameInterface = document.createElement('div');
    languageGameInterface.className = 'math-game-interface';
    languageGameInterface.style.display = 'block';
    languageGameInterface.id = 'languageGameInterface';
    
    languageGameInterface.innerHTML = `
      <button class="back-button" id="languageGameBackButton">è¿”å›</button>
      <div class="math-game-container">
        <h1 class="game-title">çœ‹å›¾è¯†å­—</h1>
        <div class="score-display">åˆ†æ•°: <span id="languageScore">0</span></div>
        <div id="imageDisplay" style="height:200px; display:flex; justify-content:center; align-items:center; margin:20px 0;">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        <div id="optionsContainer" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:10px; margin:20px 0;">
        </div>
        <div class="feedback" id="languageFeedback"></div>
      </div>
    `;
    
    document.body.appendChild(languageGameInterface);
    
    let currentWord = '';
    let languageScore = 0;
    
    async function showNextWord() {
        const imageDisplay = document.querySelector('#languageGameInterface #imageDisplay');
        const optionsContainer = document.querySelector('#languageGameInterface #optionsContainer');
        const feedback = document.querySelector('#languageGameInterface #languageFeedback');
        
        if (!imageDisplay || !optionsContainer || !feedback) {
            console.error('Required elements not found');
            return;
        }
        
        imageDisplay.innerHTML = '<div class="loading">æ­£åœ¨ç”Ÿæˆæ–°é¢˜ç›®...</div>';
        
        try {
            const wordData = await getAIWordAndSvg();
            if (!wordData) {
                console.error('Failed to get word data');
                return;
            }
            
            currentWord = wordData.word;
            imageDisplay.innerHTML = `<svg viewBox="0 0 200 200" style="width:200px; height:200px;">${wordData.svg}</svg>`;

            const allOptions = [currentWord, ...wordData.options];
            const shuffledOptions = allOptions.sort(() => Math.random() - 0.5);

            optionsContainer.innerHTML = shuffledOptions.map(option => `
                <button class="answer-option" style="padding:10px; background:#fff; border:2px solid var(--primary-color); border-radius:10px; cursor:pointer;">
                    ${option}
                </button>
            `).join('');

            const scoreElement = document.querySelector('#languageGameInterface #languageScore');
            document.querySelectorAll('#languageGameInterface .answer-option').forEach(button => {
                button.addEventListener('click', function() {
                    if (this.textContent.trim() === currentWord) {
                        feedback.textContent = 'å›ç­”æ­£ç¡®ï¼ğŸ‘';
                        feedback.style.color = '#4CAF50';
                        languageScore += 10;
                        if (scoreElement) {
                            scoreElement.textContent = languageScore;
                        }
                        setTimeout(() => {
                            feedback.textContent = '';
                            showNextWord();
                        }, 1000);
                    } else {
                        feedback.textContent = 'å†æƒ³æƒ³çœ‹ï½';
                        feedback.style.color = '#F44336';
                    }
                });
            });
        } catch (error) {
            console.error('Error in showNextWord:', error);
            imageDisplay.innerHTML = '<div class="error">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
        }
    }
    
    document.getElementById('languageGameBackButton').addEventListener('click', () => {
        const interface = document.getElementById('languageGameInterface');
        if (interface) {
            interface.remove();
        }
    });
    
    setTimeout(showNextWord, 100);
  }
}); 
</script>
</body></html>